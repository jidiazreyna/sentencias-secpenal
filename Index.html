<!doctype html>
<html>
  <head>
    <base target="_top">
    <style>
      :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --text:#0f172a;
        --muted:#64748b;
        --border:#e2e8f0;
        --primary:#2563eb;
        --primaryHover:#1d4ed8;
        --danger:#dc2626;
        --shadow: 0 10px 25px rgba(15,23,42,.08);
        --radius: 14px;
      }

      *{ box-sizing:border-box; }
      body{
        margin:0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .wrap{
        max-width: 980px;
        margin: 28px auto;
        padding: 0 16px;
      }

      .card{
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }

      .header{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap:12px;
        margin-bottom: 14px;
      }

      h1{
        font-size: 20px;
        margin:0;
        letter-spacing: .2px;
      }
      .subtitle{
        margin-top:4px;
        font-size: 13px;
        color: var(--muted);
      }

      .grid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      @media (max-width: 820px){
        .grid{ grid-template-columns: 1fr; }
      }

      .field{
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background:#fff;
      }

      .label{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 8px;
      }

      select, button{
        width:100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background:#fff;
        font-size: 14px;
        outline: none;
      }
      select:focus{
        border-color: #93c5fd;
        box-shadow: 0 0 0 3px rgba(59,130,246,.15);
      }

      .btn{
        border: none;
        background: var(--primary);
        color: white;
        font-weight: 700;
        letter-spacing: .2px;
        cursor:pointer;
        transition: .15s;
        padding: 11px 12px;
      }
      .btn:hover{ background: var(--primaryHover); }
      .btn:disabled{
        opacity: .55;
        cursor:not-allowed;
      }

      .btnSecondary{
        background:#fff;
        border: 1px solid var(--border);
        color: var(--text);
        font-weight: 600;
        cursor:pointer;
      }
      .btnSecondary:hover{
        border-color:#cbd5e1;
        background:#f8fafc;
      }

      .actions{
        display:flex;
        gap: 10px;
        margin-top: 14px;
      }
      @media (max-width: 520px){
        .actions{ flex-direction:column; }
      }

      .hint{
        font-size:12px;
        color: var(--muted);
        margin-top: 8px;
      }

      .pill{
        display:inline-flex;
        gap:8px;
        align-items:center;
        padding: 6px 10px;
        border-radius: 999px;
        border:1px solid var(--border);
        background:#f8fafc;
        font-size:12px;
        color: var(--muted);
      }

      .preview{
        display:flex;
        flex-wrap:wrap;
        gap:8px;
        margin-top:10px;
      }
      .chip{
        background:#eef2ff;
        border:1px solid #c7d2fe;
        color:#1e3a8a;
        font-size:12px;
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 600;
      }
      .warn{
        color: var(--danger);
        font-weight: 600;
        font-size: 12px;
        margin-top: 10px;
      }

      #out{
        margin-top: 14px;
        padding-top: 12px;
        border-top: 1px dashed var(--border);
        font-size: 14px;
      }
      a{ color: var(--primary); font-weight: 700; text-decoration:none; }
      a:hover{ text-decoration: underline; }

      .rowStack{
        display:grid;
        gap:10px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <div class="header">
          <div>
            <h1>Corrector de Sentencias</h1>
            <div class="subtitle">Seleccioná un DOCX de Entrada, definí presidencia y el orden de votos.</div>
          </div>
        </div>

        <div class="grid">
          <!-- Archivos -->
          <div class="field">
            <div class="label">
              <span>Archivo de Entrada</span>
              <span style="font-size:12px; color:var(--muted)">Drive</span>
            </div>
            <div class="rowStack">
              <button class="btnSecondary" onclick="loadFiles()">Cargar archivos</button>
              <select id="fileSelect"></select>
            </div>
            <div class="hint">Se muestran solo DOCX (no Google Docs, no PDFs).</div>
          </div>

          <!-- Presidencia -->
          <div class="field">
            <div class="label">
              <span>Presidencia</span>
              <span style="font-size:12px; color:var(--muted)">Debe estar entre los 3 que votan</span>
            </div>
            <select id="presidente"></select>
            <div class="hint">Elegí el Vocal que preside la Sala.</div>
          </div>

          <!-- Orden -->
          <div class="field" style="grid-column:1/-1">
            <div class="label">
              <span>Vocales y orden de votos</span>
              <span style="font-size:12px; color:var(--muted)">3 distintos, en orden</span>
            </div>

            <div class="grid">
              <select id="o1"></select>
              <select id="o2"></select>
              <select id="o3"></select>
            </div>

            <div class="preview" id="preview"></div>
            <div class="warn" id="warn" style="display:none"></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="runBtn" onclick="run()">Corregir</button>
        </div>

        <div id="out"></div>
      </div>
    </div>

    <script>
      const VOCALES = [
        "Aída Tarditti",
        "Domingo Sesín",
        "Luis Enrique Rubio",
        "María Marta Cáceres de Bollati",
        "Sebastián Cruz López Peña",
        "Jessica Valentini"
      ];

      function fillSelect(sel, values) {
        sel.innerHTML = "";
        values.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
      }

      function updatePreviewAndValidate() {
        const o1 = document.getElementById("o1").value;
        const o2 = document.getElementById("o2").value;
        const o3 = document.getElementById("o3").value;
        const presidente = document.getElementById("presidente").value;

        const arr = [o1, o2, o3];

        const preview = document.getElementById("preview");
        preview.innerHTML = "";
        arr.forEach((name, idx) => {
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.textContent = `${idx + 1}. ${name}`;
          preview.appendChild(chip);
        });

        const warn = document.getElementById("warn");
        const uniq = new Set(arr);
        let msg = "";

        if (uniq.size !== 3) msg = "Los 3 vocales deben ser distintos.";
        else if (!uniq.has(presidente)) msg = "La presidencia debe estar entre los 3 vocales seleccionados.";

        if (msg) {
          warn.style.display = "block";
          warn.textContent = "⚠️ " + msg;
          document.getElementById("runBtn").disabled = true;
        } else {
          warn.style.display = "none";
          warn.textContent = "";
          document.getElementById("runBtn").disabled = false;
        }
      }

      function init() {
        ["presidente","o1","o2","o3"].forEach(id => {
          fillSelect(document.getElementById(id), VOCALES);
        });

        // Defaults
        document.getElementById("presidente").value = "Sebastián Cruz López Peña";
        document.getElementById("o1").value = "Sebastián Cruz López Peña";
        document.getElementById("o2").value = "Aída Tarditti";
        document.getElementById("o3").value = "María Marta Cáceres de Bollati";

        ["presidente","o1","o2","o3"].forEach(id => {
          document.getElementById(id).addEventListener("change", updatePreviewAndValidate);
        });

        updatePreviewAndValidate();
        loadFiles();
      }

      function loadFiles() {
        google.script.run.withSuccessHandler(files => {
          const sel = document.getElementById("fileSelect");
          sel.innerHTML = "";

          if (!files || files.length === 0) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "(No hay DOCX en Entrada)";
            sel.appendChild(opt);
            return;
          }

          files.forEach(f => {
            const opt = document.createElement("option");
            opt.value = f.id;
            opt.textContent = f.name;
            sel.appendChild(opt);
          });
        }).withFailureHandler(err => {
          document.getElementById("out").innerHTML = `<p style="color:${getComputedStyle(document.documentElement).getPropertyValue('--danger')}">${err.message}</p>`;
        }).listInputFiles();
      }

      function run() {
        const fileId = document.getElementById("fileSelect").value;
        if (!fileId) {
          document.getElementById("out").innerHTML = `<p style="color:${getComputedStyle(document.documentElement).getPropertyValue('--danger')}">No hay archivo DOCX seleccionado.</p>`;
          return;
        }

        const settings = {
          presidente: document.getElementById("presidente").value,
          ordenVotos: [
            document.getElementById("o1").value,
            document.getElementById("o2").value,
            document.getElementById("o3").value
          ]
        };

        document.getElementById("out").innerHTML = "Procesando…";

        google.script.run
        .withSuccessHandler(res => {
          document.getElementById("out").innerHTML = `
            <p><b>Listo</b></p>
            <p><a href="${res.correctedDocxUrl}" target="_blank">WORD corregido (DOCX)</a></p>
            <p><a href="${res.comparacionDocxUrl}" target="_blank">WORD comparación (DOCX, horizontal)</a></p>
          `;

        })

          .withFailureHandler(err => {
            document.getElementById("out").innerHTML = `<p style="color:red">${err.message}</p>`;
          })
          .correctDocx(fileId, settings);

      }

      init();
    </script>
  </body>
</html>
